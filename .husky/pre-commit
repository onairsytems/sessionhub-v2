#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "🔍 Running pre-commit quality checks..."

# Check for large files (> 1MB)
echo "📏 Checking for large files..."
files=$(git diff --cached --name-only)
for file in $files; do
  if [ -f "$file" ]; then
    size=$(wc -c < "$file")
    if [ $size -gt 1048576 ]; then
      echo "❌ File '$file' is larger than 1MB ($(($size / 1048576))MB)"
      echo "Large files should not be committed. Consider:"
      echo "  - Moving build artifacts to .gitignore"
      echo "  - Using Git LFS for large assets"
      echo "  - Compressing the file"
      exit 1
    fi
  fi
done
echo "✅ No large files detected"

# Run TypeScript compiler check
echo "📘 Checking TypeScript compilation..."
npx tsc --noEmit
if [ $? -ne 0 ]; then
  echo "❌ TypeScript compilation failed! Fix errors before committing."
  exit 1
fi

# Run ESLint
echo "🔧 Running ESLint..."
npx eslint . --ext .ts,.tsx,.js,.jsx --max-warnings 0
if [ $? -ne 0 ]; then
  echo "❌ ESLint found errors! Fix them before committing."
  exit 1
fi

# Run the error detection system
echo "🛡️ Running SessionHub Error Detection..."
npm run error:check
if [ $? -ne 0 ]; then
  echo "❌ Error detection found issues! Fix them before committing."
  exit 1
fi

# Run tests
echo "🧪 Running tests..."
npm test -- --passWithNoTests
if [ $? -ne 0 ]; then
  echo "❌ Tests failed! Fix them before committing."
  exit 1
fi

echo "✅ All quality checks passed! Proceeding with commit..."

# Run lint-staged for formatting
npx lint-staged